/**
 * Stub Provider - Deterministic responses for testing
 */

import { LLMProvider, LLMCompletionOptions, LLMResponse } from './base.js';

export class StubProvider extends LLMProvider {
  readonly name = 'stub';
  private deterministic: boolean;

  constructor(deterministic: boolean = true) {
    super();
    this.deterministic = deterministic;
  }

  async complete(options: LLMCompletionOptions): Promise<LLMResponse> {
    // Check if JSON response is expected
    const isJson = options.responseFormat === 'json';
    const userMessage = options.messages.find(m => m.role === 'user')?.content || '';
    
    let content: string;
    
    if (isJson) {
      content = this.generateJsonResponse(userMessage);
    } else {
      content = this.generateTextResponse(userMessage);
    }

    return {
      content,
      usage: {
        promptTokens: 100,
        completionTokens: 50,
        totalTokens: 150,
      },
    };
  }

  async isAvailable(): Promise<boolean> {
    return true;
  }

  private generateJsonResponse(prompt: string): string {
    // Check for probability estimation request
    if (prompt.toLowerCase().includes('probability') || prompt.toLowerCase().includes('estimate')) {
      const baseProb = this.deterministic ? 0.55 : 0.3 + Math.random() * 0.4;
      
      return JSON.stringify({
        estimated_probability: baseProb,
        confidence: this.deterministic ? 0.7 : 0.5 + Math.random() * 0.3,
        key_factors: [
          'Historical precedent analysis',
          'Current market sentiment',
          'Time remaining until resolution',
        ],
        assumptions: [
          'No major unexpected events',
          'Current trends continue',
          'Market information is reasonably efficient',
        ],
        failure_modes: [
          'Black swan events not captured',
          'Model may miss recent developments',
          'Limited historical data for novel situations',
        ],
      });
    }

    // Default JSON response
    return JSON.stringify({
      response: 'This is a stub response for testing purposes.',
      confidence: 0.5,
    });
  }

  private generateTextResponse(prompt: string): string {
    if (prompt.toLowerCase().includes('analyze')) {
      return `Analysis Summary (Stub Provider)

This is a simulated analysis for testing purposes. In production, this would contain:

1. Detailed market analysis
2. Key factors affecting probability
3. Risk assessment
4. Recommendations

Note: This response is generated by the stub provider for offline testing.`;
    }

    return 'This is a stub response for testing purposes. Configure a real provider (OpenAI or Anthropic) for actual analysis.';
  }
}

